#!/usr/bin/env node
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _path = _interopRequireDefault(require("path"));

var _graphql = require("./graphql");

var _helpers = require("../helpers");

var _cliColor = _interopRequireDefault(require("cli-color"));

var client = (0, _helpers.setClient)();

var packageJsonPath = _path["default"].join(_path["default"].dirname(__dirname), '..', 'package.json');

var targetPackageJsonPath = _path["default"].join(_path["default"].dirname(process.argv[1]), '..', '..', 'package.json');

var checkPackage = function checkPackage(name) {
  return new Promise(function (resolve, reject) {
    client.query({
      query: _graphql.query,
      variables: {
        name: name
      }
    }).then(function (result) {
      var count = result.data._allPackagesMeta.count;
      return resolve(count);
    })["catch"](function (error) {
      return reject(error);
    });
  });
};

var createPackage = function createPackage(name) {
  client.mutate({
    mutation: _graphql.mutation,
    variables: {
      name: name
    }
  }).then(function () {
    return displayMessage(name);
  })["catch"](_helpers.displayError);
};

var displayMessage = function displayMessage(targetPackageName) {
  return (0, _helpers.getPackageJson)(packageJsonPath).then(function (json) {
    var name = json.name,
        version = json.version;
    (0, _helpers.printMessage)(['✌️ ✌️ ✌️', '', "\uD83D\uDCE6 ".concat(_cliColor["default"].bold.red("".concat(name, "@").concat(version))), '', "\uD83D\uDC49 Here is the link to visualize real-time ".concat(_cliColor["default"].bold(targetPackageName), " downloads"), '', "\uD83D\uDD17 ".concat(_cliColor["default"].underline.green((0, _helpers.getTrackingUri)(targetPackageName)))]);
  })["catch"](_helpers.displayError);
};

(0, _helpers.getPackageJson)(targetPackageJsonPath).then(function (json) {
  var name = json.name;
  checkPackage(name).then(function (count) {
    return count ? displayMessage(name) : createPackage(name);
  })["catch"](_helpers.displayError);
})["catch"](_helpers.displayError);